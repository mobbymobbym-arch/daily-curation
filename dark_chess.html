<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æš—æ£‹å¤§å¸« Pro - PWA è‡ªä¸»ç‰ˆ</title>
    
    <!-- PWA & Mobile Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="æš—æ£‹å¤§å¸«">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --red: #d32f2f;
            --black: #212121;
            --wood-dark: #3e2723;
            --wood-mid: #5d4037;
            --wood-light: #8d6e63;
            --gold: #ffd700;
            --bg: #efebe9;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg);
            margin: 0;
            padding: 0;
            font-family: -apple-system, "Noto Sans TC", sans-serif;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
        }

        /* UI Layout */
        .top-bar {
            padding: calc(10px + var(--safe-top)) 20px 10px;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 100;
        }

        .id-box {
            font-weight: 800;
            font-size: 14px;
            padding: 6px 14px;
            border-radius: 20px;
            border: 2px solid #eee;
            transition: all 0.3s;
        }
        .id-red { background: #ffebee; color: var(--red); border-color: #ffcdd2; }
        .id-black { background: #e0e0e0; color: var(--black); border-color: #bdbdbd; }

        .game-status {
            text-align: center;
            padding: 10px;
            font-weight: bold;
            color: var(--wood-dark);
            height: 40px;
        }

        .game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            position: relative;
        }

        /* Chess Board */
        .board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 4px;
            background: linear-gradient(135deg, var(--wood-mid), var(--wood-dark));
            padding: 8px;
            border-radius: 12px;
            width: 100%;
            max-width: 360px;
            aspect-ratio: 4/8;
            box-shadow: 0 15px 35px rgba(0,0,0,0.4);
            border: 4px solid var(--wood-dark);
        }

        .cell {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255,255,255,0.03);
            border-radius: 50%;
        }

        /* Pieces */
        .piece {
            width: 90%;
            height: 90%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: clamp(20px, 6vw, 28px);
            font-weight: 900;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .piece.back {
            background: radial-gradient(circle at 30% 30%, var(--wood-light), var(--wood-mid));
            border: 2px solid var(--wood-dark);
        }
        .piece.back::after {
            content: 'æ¥šæ²³';
            font-size: 10px;
            color: rgba(255,255,255,0.2);
            transform: rotate(-45deg);
        }

        .piece.red { background: #fff; color: var(--red); border: 3px solid var(--red); }
        .piece.black { background: #333; color: #fff; border: 3px solid #000; }

        .selected { transform: scale(1.15); box-shadow: 0 0 15px var(--gold); z-index: 10; border-color: var(--gold) !important; }
        .last-move::after {
            content: '';
            position: absolute;
            width: 110%;
            height: 110%;
            border: 2px solid var(--gold);
            border-radius: 50%;
            pointer-events: none;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.5; transform: scale(1); }
        }

        .bottom-bar {
            padding: 15px 20px calc(15px + var(--safe-bottom));
            background: #fff;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: var(--wood-mid);
            color: white;
            border: none;
            border-radius: 30px;
            font-weight: 800;
            font-size: 16px;
            box-shadow: 0 4px 0 var(--wood-dark);
            transition: all 0.1s;
        }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--wood-dark); }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: #fff;
            width: 85%;
            max-width: 320px;
            padding: 30px;
            border-radius: 24px;
            text-align: center;
        }
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div id="id-display" class="id-box">èº«åˆ†æœªå®š</div>
        <div style="cursor:pointer; font-size:24px;" onclick="showStats()"><i class="fas fa-trophy" style="color:var(--gold)"></i></div>
    </div>

    <div class="game-status" id="status">é»æ“Šæ£‹å­ç¿»ç‰Œ</div>

    <div class="game-area">
        <div id="board" class="board"></div>
    </div>

    <div class="bottom-bar">
        <button class="btn" onclick="confirmReset()">é‡æ–°é–‹å§‹ / æŠ•é™</button>
    </div>

    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <h2 style="color:var(--wood-dark)">æˆ°ç¸¾ç´€éŒ„</h2>
            <div id="stat-summary" style="font-size: 18px; margin: 20px 0; font-weight: bold;"></div>
            <div id="stat-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;"></div>
            <button class="btn" onclick="closeModal()">è¿”å›</button>
        </div>
    </div>

    <script>
        const VALS = { 'å¸¥': 7, 'å°‡': 7, 'ä»•': 6, 'å£«': 6, 'ç›¸': 5, 'è±¡': 5, 'ä¿¥': 4, 'è»Š': 4, 'å‚Œ': 3, 'é¦¬': 3, 'ç‚®': 2, 'åŒ…': 2, 'å…µ': 1, 'å’': 1 };
        const WEIGHTS = { 7: 2000, 6: 1000, 5: 700, 4: 500, 3: 350, 2: 400, 1: 150 }; // ç‚®çš„åƒ¹å€¼ç•¥é«˜æ–¼é¦¬
        
        const PIECES_CONFIG = [
            {t:'å¸¥', l:7, c:'red', n:1}, {t:'å°‡', l:7, c:'black', n:1},
            {t:'ä»•', l:6, c:'red', n:2}, {t:'å£«', l:6, c:'black', n:2},
            {t:'ç›¸', l:5, c:'red', n:2}, {t:'è±¡', l:5, c:'black', n:2},
            {t:'ä¿¥', l:4, c:'red', n:2}, {t:'è»Š', l:4, c:'black', n:2},
            {t:'å‚Œ', l:3, c:'red', n:2}, {t:'é¦¬', l:3, c:'black', n:2},
            {t:'ç‚®', l:2, c:'red', n:2}, {t:'åŒ…', l:2, c:'black', n:2},
            {t:'å…µ', l:1, c:'red', n:5}, {t:'å’', l:1, c:'black', n:5}
        ];

        let board = [], playerColor = null, turn = null, selected = null, lastIdx = -1, over = false, thinking = false;

        function initGame() {
            board = [];
            let p = [];
            PIECES_CONFIG.forEach(x => {
                for(let i=0; i<x.n; i++) p.push({...x, flipped: false});
            });
            p.sort(() => Math.random() - 0.5);
            board = p;
            playerColor = null; turn = null; selected = null; lastIdx = -1; over = false; thinking = false;
            render();
            updateUI();
        }

        function render() {
            const el = document.getElementById('board');
            el.innerHTML = '';
            board.forEach((p, i) => {
                const c = document.createElement('div');
                c.className = 'cell' + (i === lastIdx ? ' last-move' : '');
                c.onclick = () => handleTap(i);
                if(p) {
                    const pc = document.createElement('div');
                    pc.className = p.flipped ? `piece ${p.c}${selected === i ? ' selected' : ''}` : 'piece back';
                    pc.innerText = p.flipped ? p.t : '';
                    c.appendChild(pc);
                }
                el.appendChild(c);
            });
        }

        function handleTap(i) {
            if(over || thinking) return;
            const p = board[i];

            // ç¿»ç‰Œ
            if(p && !p.flipped) {
                p.flipped = true;
                lastIdx = i;
                if(!playerColor) {
                    playerColor = p.c;
                    turn = (p.c === 'red' ? 'black' : 'red');
                } else {
                    turn = (p.c === 'red' ? 'black' : 'red');
                }
                checkEndTurn();
                return;
            }

            // é¸å–è‡ªå·±çš„æ£‹å­
            if(p && p.flipped && p.c === (turn || playerColor)) {
                if(playerColor && p.c !== playerColor) return; // ä¸èƒ½åœ¨è‡ªå·±å›åˆå‹•AIçš„æ£‹å­
                selected = i;
                render();
                return;
            }

            // ç§»å‹•æˆ–åƒå­
            if(selected !== null) {
                if(canMove(selected, i, board)) {
                    executeMove(selected, i);
                    checkEndTurn();
                } else {
                    selected = null;
                    render();
                }
            }
        }

        function canMove(f, t, b) {
            const p1 = b[f], p2 = b[t];
            if(!p1) return false;
            const r1 = Math.floor(f/4), c1 = f%4, r2 = Math.floor(t/4), c2 = t%4;
            const dist = Math.abs(r1-r2) + Math.abs(c1-c2);

            // ç‚®çš„ç‰¹æ®Šè¦å‰‡
            if(p1.l === 2) {
                if(r1 !== r2 && c1 !== c2) return false;
                let midCount = 0;
                if(r1 === r2) {
                    for(let k = Math.min(c1, c2)+1; k < Math.max(c1, c2); k++) if(b[r1*4+k]) midCount++;
                } else {
                    for(let k = Math.min(r1, r2)+1; k < Math.max(r1, r2); k++) if(b[k*4+c1]) midCount++;
                }
                
                if(!p2) return midCount === 0 && dist === 1; // å¹³ç§»ä¸€æ ¼
                if(p2 && p2.flipped && midCount === 1 && p1.c !== p2.c) return true; // éš”å±±æ‰“ç‰›
                return false;
            }

            // ä¸€èˆ¬æ£‹å­è¦å‰‡
            if(dist !== 1) return false;
            if(!p2) return true; // ç©ºä½ç§»å‹•
            if(!p2.flipped || p1.c === p2.c) return false; // ä¸èƒ½åƒéšŠå‹æˆ–è“‹è‘—çš„

            // éšç´šåˆ¤å®š
            if(p1.l === 7 && p2.l === 1) return false; // å°‡ä¸èƒ½åƒå’
            if(p1.l === 1 && p2.l === 7) return true;  // å’å¯ä»¥åƒå°‡
            return p1.l >= p2.l;
        }

        function executeMove(f, t) {
            board[t] = board[f];
            board[f] = null;
            lastIdx = t;
            selected = null;
        }

        function checkEndTurn() {
            render();
            updateUI();
            const winner = checkWinner();
            if(winner) {
                over = true;
                const isWin = (winner === playerColor);
                saveStat(isWin);
                setTimeout(() => alert(isWin ? "ğŸ‰ æ­å–œï¼ä½ è´äº†ï¼" : "ğŸ’€ éºæ†¾ï¼ŒAI ç²å‹ã€‚"), 200);
                return;
            }
            
            // åˆ‡æ›å›åˆ
            turn = (turn === 'red' ? 'black' : 'red');
            if(turn !== playerColor) aiMove();
        }

        function checkWinner() {
            const redCount = board.filter(p => p && p.c === 'red').length;
            const blackCount = board.filter(p => p && p.c === 'black').length;
            if(redCount === 0) return 'black';
            if(blackCount === 0) return 'red';
            return null;
        }

        function aiMove() {
            thinking = true;
            updateUI();
            setTimeout(() => {
                const aiColor = (playerColor === 'red' ? 'black' : 'red');
                let moves = [];
                
                board.forEach((p, i) => {
                    if(!p) return;
                    // AI å¯ä»¥é¸æ“‡ç¿»ç‰Œæˆ–ç§»å‹•
                    if(!p.flipped) {
                        moves.push({ type: 'flip', f: i, score: 100 + Math.random() * 50 });
                    } else if(p.c === aiColor) {
                        for(let t=0; t<32; t++) {
                            if(canMove(i, t, board)) {
                                moves.push({ type: 'move', f: i, t: t, score: evaluateMove(i, t, aiColor) });
                            }
                        }
                    }
                });

                if(moves.length === 0) { over = true; updateUI(); return; }
                moves.sort((a, b) => b.score - a.score);
                const best = moves.filter(m => m.score > moves[0].score - 20);
                const m = best[Math.floor(Math.random() * best.length)];

                if(m.type === 'flip') {
                    board[m.f].flipped = true;
                    lastIdx = m.f;
                } else {
                    executeMove(m.f, m.t);
                }
                
                thinking = false;
                checkEndTurn();
            }, 800);
        }

        function evaluateMove(f, t, aiColor) {
            const p = board[f];
            const target = board[t];
            let score = 0;

            if(target) {
                score += WEIGHTS[target.l] * 2; // åƒå­æ¬Šé‡å¤§
            } else {
                score += 10; // æ™®é€šç§»å‹•
            }

            // é¢¨éšªè©•ä¼°ï¼šæ¨¡æ“¬ç§»å‹•å¾Œæ˜¯å¦æœƒè¢«ååƒ
            const virtualBoard = [...board];
            virtualBoard[t] = virtualBoard[f];
            virtualBoard[f] = null;

            let risk = 0;
            virtualBoard.forEach((ep, ei) => {
                if(ep && ep.flipped && ep.c !== aiColor) {
                    if(canMove(ei, t, virtualBoard)) {
                        risk = Math.max(risk, WEIGHTS[p.l]);
                    }
                }
            });

            return score - (risk * 1.5);
        }

        function updateUI() {
            const idBox = document.getElementById('id-display');
            const status = document.getElementById('status');
            if(playerColor) {
                idBox.innerText = `ä½ æ˜¯ ${playerColor === 'red' ? 'ç´…æ–¹ğŸ®' : 'é»‘æ–¹â™Ÿï¸'}`;
                idBox.className = `id-box id-${playerColor}`;
            }
            if(over) {
                status.innerText = "éŠæˆ²çµæŸ";
            } else {
                status.innerText = thinking ? "AI æ€è€ƒä¸­..." : (turn === playerColor ? "ä½ çš„å›åˆ" : "AI å›åˆ");
            }
        }

        // Stats & LocalStorage
        function saveStat(win) {
            let h = JSON.parse(localStorage.getItem('chess_stats_v2') || '[]');
            h.unshift({ win, date: new Date().toLocaleString() });
            localStorage.setItem('chess_stats_v2', JSON.stringify(h.slice(0, 50)));
        }

        function showStats() {
            const h = JSON.parse(localStorage.getItem('chess_stats_v2') || '[]');
            const wins = h.filter(x => x.win).length;
            document.getElementById('stat-summary').innerText = `ç¸½å±€æ•¸: ${h.length} | å‹ç‡: ${h.length ? (wins/h.length*100).toFixed(1) : 0}%`;
            document.getElementById('stat-list').innerHTML = h.map(x => `
                <div class="history-item">
                    <span>${x.date}</span>
                    <span style="color:${x.win ? 'var(--red)' : 'var(--black)'}">${x.win ? 'ç²å‹' : 'æ•—åŒ—'}</span>
                </div>
            `).join('');
            document.getElementById('stats-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('stats-modal').style.display = 'none'; }
        function confirmReset() { if(confirm("ç¢ºå®šè¦é‡é–‹æˆ–æŠ•é™å—ï¼Ÿ")) initGame(); }

        initGame();
    </script>
</body>
</html>
