<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ÊöóÊ£ãÂ§ßÂ∏´ÔºöÈõ≤Á´ØÂ∞çÂºà</title>
    
    <!-- PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÊöóÊ£ãÂ§ßÂ∏´">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --crimson: #8e1a1a;
            --charcoal: #2a2a2a;
            --paper: #f4ece0;
            --ink: #332c28;
            --gold-leaf: #d4af37;
            --wood-frame: #4a2c1d;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--paper);
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            margin: 0;
            padding: 0;
            font-family: "Noto Serif TC", serif;
            display: flex;
            flex-direction: column;
            height: 100dvh;
            overflow: hidden;
            user-select: none;
            color: var(--ink);
        }

        /* Top Bar - Calligraphy Style */
        .header {
            padding: calc(15px + var(--safe-top)) 20px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .title-area h1 {
            margin: 0;
            font-size: 20px;
            letter-spacing: 2px;
            color: var(--wood-frame);
        }

        .id-badge {
            font-size: 13px;
            padding: 4px 12px;
            border-radius: 4px;
            border: 1px solid var(--wood-frame);
            background: rgba(255,255,255,0.5);
        }
        .id-red { color: var(--crimson); border-color: var(--crimson); }
        .id-black { color: var(--charcoal); border-color: var(--charcoal); }

        /* Game Status */
        .status-msg {
            text-align: center;
            padding: 15px;
            font-size: 18px;
            height: 55px;
            font-weight: 700;
        }

        /* Board - Classical Chinese Style */
        .main-stage {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            min-height: 0;
        }

        .chess-table {
            background: var(--wood-frame);
            padding: 12px;
            border-radius: 8px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 0 50px rgba(0,0,0,0.5);
            border: 2px solid var(--gold-leaf);
            width: 100%;
            height: 100%;
            max-width: calc((100dvh - 280px) * 0.5);
            max-height: calc(100dvh - 280px);
            aspect-ratio: 4 / 8;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(8, 1fr);
            gap: 2px;
        }

        .slot {
            background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 100% 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* Piece Redesign */
        .token {
            width: 88%;
            height: 88%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: min(7vw, 28px);
            cursor: pointer;
            transition: all 0.2s ease-out;
            position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.3);
        }

        .token.hidden {
            background: radial-gradient(circle at 35% 35%, #5d4037, #3e2723);
            border: 2px solid #2a1b15;
        }
        .token.hidden::after {
            content: 'Êº¢';
            font-size: 12px;
            color: rgba(255,255,255,0.1);
        }

        .token.revealed {
            background: #fff;
            background-image: radial-gradient(circle, #fff 60%, #eee 100%);
            box-shadow: 0 5px 0 #ccc, 0 8px 15px rgba(0,0,0,0.2);
        }
        .token.red { color: var(--crimson); border: 2px solid var(--crimson); }
        .token.black { color: var(--charcoal); border: 2px solid var(--charcoal); }

        .token.active { 
            transform: scale(1.1) translateY(-5px); 
            box-shadow: 0 15px 25px rgba(0,0,0,0.3);
            border-color: var(--gold-leaf);
            z-index: 10;
        }

        .focus-ring::after {
            content: '';
            position: absolute;
            width: 120%;
            height: 120%;
            border: 2px dashed var(--gold-leaf);
            border-radius: 50%;
            animation: rotate 4s linear infinite;
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Controls */
        .footer-tools {
            padding: 20px 25px calc(20px + var(--safe-bottom));
            display: flex;
            gap: 15px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            background: var(--crimson);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 900;
            font-size: 16px;
            box-shadow: 0 4px 0 #5a1111;
            letter-spacing: 2px;
        }
        .action-btn.secondary { background: var(--wood-frame); box-shadow: 0 4px 0 #2a1b15; }
        .action-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #000; }

        /* Stats Modal */
        .overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(8px);
        }
        .scroll-content {
            background: var(--paper);
            width: 90%;
            max-width: 340px;
            padding: 40px 20px;
            border: 8px double var(--wood-frame);
            position: relative;
            text-align: center;
        }
        .scroll-content::before {
            content: 'üìú';
            position: absolute;
            top: -25px; left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="title-area">
            <h1>ÊöóÊ£ãÂ§ßÂ∏´</h1>
        </div>
        <div id="side-tag" class="id-badge">Â∞çÂ±ÄÈñãÂßã</div>
        <div onclick="toggleStats()" style="cursor:pointer; font-size: 22px;"><i class="fas fa-scroll"></i></div>
    </header>

    <div class="status-msg" id="status">ÁøªÈñãÊ£ãÂ≠êÔºåÂÆöÂ•™Á¥ÖÈªë</div>

    <main class="main-stage">
        <div id="board" class="chess-table"></div>
    </main>

    <div class="footer-tools">
        <button class="action-btn secondary" onclick="confirmReset()">Ê±ÇÂíå / ÈáçÈñã</button>
    </div>

    <div id="modal" class="overlay">
        <div class="scroll-content">
            <h2 style="margin-top:0">Ê£ãÂ±ÄÊà∞Â†±</h2>
            <div id="summary" style="font-size: 1.2rem; margin: 20px 0; color: var(--crimson)"></div>
            <div id="history" style="max-height: 200px; overflow-y: auto; font-family: sans-serif; font-size: 14px; text-align: left;"></div>
            <button class="action-btn" style="margin-top:25px; width:100%" onclick="toggleStats()">Âêà‰∏äÂç∑Ëª∏</button>
        </div>
    </div>

    <script>
        const VALS = { 'Â∏•': 7, 'Â∞á': 7, '‰ªï': 6, 'Â£´': 6, 'Áõ∏': 5, 'Ë±°': 5, '‰ø•': 4, 'Ëªä': 4, 'ÂÇå': 3, 'È¶¨': 3, 'ÁÇÆ': 2, 'ÂåÖ': 2, 'ÂÖµ': 1, 'Âçí': 1 };
        const WEIGHTS = { 7: 2000, 6: 1000, 5: 700, 4: 500, 3: 350, 2: 450, 1: 150 };
        const CFG = [
            {t:'Â∏•', l:7, c:'red', n:1}, {t:'Â∞á', l:7, c:'black', n:1},
            {t:'‰ªï', l:6, c:'red', n:2}, {t:'Â£´', l:6, c:'black', n:2},
            {t:'Áõ∏', l:5, c:'red', n:2}, {t:'Ë±°', l:5, c:'black', n:2},
            {t:'‰ø•', l:4, c:'red', n:2}, {t:'Ëªä', l:4, c:'black', n:2},
            {t:'ÂÇå', l:3, c:'red', n:2}, {t:'È¶¨', l:3, c:'black', n:2},
            {t:'ÁÇÆ', l:2, c:'red', n:2}, {t:'ÂåÖ', l:2, c:'black', n:2},
            {t:'ÂÖµ', l:1, c:'red', n:5}, {t:'Âçí', l:1, c:'black', n:5}
        ];

        let board = [], playerColor = null, turn = null, selected = null, lastIdx = -1, over = false, aiThinking = false;

        function start() {
            let p = [];
            CFG.forEach(x => { for(let i=0; i<x.n; i++) p.push({...x, flipped: false}); });
            board = p.sort(() => Math.random() - 0.5);
            playerColor = turn = selected = null;
            lastIdx = -1; over = aiThinking = false;
            draw();
            syncUI();
        }

        function draw() {
            const el = document.getElementById('board');
            el.innerHTML = '';
            board.forEach((p, i) => {
                const s = document.createElement('div');
                s.className = 'slot' + (i === lastIdx ? ' focus-ring' : '');
                s.onclick = () => tap(i);
                if(p) {
                    const t = document.createElement('div');
                    t.className = p.flipped ? `token revealed ${p.c}${selected === i ? ' active' : ''}` : 'token hidden';
                    t.innerText = p.flipped ? p.t : '';
                    s.appendChild(t);
                }
                el.appendChild(s);
            });
        }

        function tap(i) {
            if(over || aiThinking) return;
            const p = board[i];

            if(p && !p.flipped) {
                p.flipped = true;
                lastIdx = i;
                if(!playerColor) {
                    playerColor = p.c;
                    turn = (p.c === 'red' ? 'black' : 'red');
                } else {
                    turn = (turn === 'red' ? 'black' : 'red');
                }
                check();
                return;
            }

            if(p && p.flipped && p.c === turn) {
                if(playerColor && p.c !== playerColor) return;
                selected = i;
                draw();
                return;
            }

            if(selected !== null) {
                if(canMove(selected, i, board)) {
                    board[i] = board[selected];
                    board[selected] = null;
                    lastIdx = i;
                    selected = null;
                    turn = (turn === 'red' ? 'black' : 'red');
                    check();
                } else {
                    selected = null;
                    draw();
                }
            }
        }

        function canMove(f, t, b) {
            const p1 = b[f], p2 = b[t];
            if(!p1) return false;
            const r1 = Math.floor(f/4), c1 = f%4, r2 = Math.floor(t/4), c2 = t%4;
            const dist = Math.abs(r1-r2) + Math.abs(c1-c2);

            if(p1.l === 2) {
                if(r1 !== r2 && c1 !== c2) return false;
                let mids = 0;
                if(r1 === r2) for(let k = Math.min(c1, c2)+1; k < Math.max(c1, c2); k++) if(b[r1*4+k]) mids++;
                else for(let k = Math.min(r1, r2)+1; k < Math.max(r1, r2); k++) if(b[k*4+c1]) mids++;
                if(!p2) return mids === 0 && dist === 1;
                return (p2 && p2.flipped && mids === 1 && p1.c !== p2.c);
            }

            if(dist !== 1) return false;
            if(!p2) return true;
            if(!p2.flipped || p1.c === p2.c) return false;
            if(p1.l === 7 && p2.l === 1) return false;
            if(p1.l === 1 && p2.l === 7) return true;
            return p1.l >= p2.l;
        }

        function check() {
            draw();
            syncUI();
            const r = board.filter(p => p && p.c === 'red').length;
            const b = board.filter(p => p && p.c === 'black').length;
            let winner = r === 0 ? 'black' : (b === 0 ? 'red' : null);
            if(winner) {
                over = true;
                const win = winner === playerColor;
                save(win);
                setTimeout(() => alert(win ? "„ÄåÊóóÈñãÂæóÂãùÔºåÊô∫ÂèñÂçÉËªçÔºÅ„Äç" : "„ÄåÂãùÊïó‰πÉÂÖµÂÆ∂Â∏∏‰∫ãÔºåË´ãÊç≤ÂúüÈáç‰æÜ„ÄÇ„Äç"), 300);
                return;
            }
            if(turn && turn !== playerColor) ai();
        }

        function ai() {
            aiThinking = true;
            syncUI();
            setTimeout(() => {
                const mine = (playerColor === 'red' ? 'black' : 'red');
                let moves = [];
                board.forEach((p, i) => {
                    if(!p) return;
                    if(!p.flipped) moves.push({ type: 'flip', f: i, s: 100 + Math.random() * 50 });
                    else if(p.c === mine) {
                        for(let t=0; t<32; t++) if(canMove(i, t, board)) moves.push({ type: 'move', f: i, t: t, s: score(i, t, mine) });
                    }
                });
                if(moves.length === 0) { over = true; syncUI(); return; }
                moves.sort((a, b) => b.s - a.s);
                const best = moves.filter(m => m.s > moves[0].s - 20);
                const m = best[Math.floor(Math.random() * best.length)];
                if(m.type === 'flip') { board[m.f].flipped = true; lastIdx = m.f; }
                else { board[m.t] = board[m.f]; board[m.f] = null; lastIdx = m.t; }
                aiThinking = false;
                turn = playerColor;
                check();
            }, 800);
        }

        function score(f, t, mine) {
            const p = board[f], tar = board[t];
            let s = tar ? WEIGHTS[tar.l] * 2 : 10;
            const next = [...board]; next[t] = next[f]; next[f] = null;
            let risk = 0;
            next.forEach((ep, ei) => { if(ep && ep.flipped && ep.c !== mine && canMove(ei, t, next)) risk = Math.max(risk, WEIGHTS[p.l]); });
            return s - (risk * 1.6);
        }

        function syncUI() {
            const tag = document.getElementById('side-tag'), msg = document.getElementById('status');
            if(playerColor) {
                tag.innerText = `Âü∑${playerColor === 'red' ? 'Á¥ÖüèÆ' : 'Èªë‚ôüÔ∏è'}`;
                tag.className = `id-badge id-${playerColor}`;
            }
            msg.innerText = over ? "Â±ÄÁµÇ" : (aiThinking ? "Â∞çÊâãÊ≤âÊÄù‰∏≠..." : (turn === playerColor ? "Ë´ãÈÄ≤Âºà" : "Â∞çÊâãË°åÊ£ã‰∏≠"));
        }

        function save(win) {
            let h = JSON.parse(localStorage.getItem('darkchess_v5') || '[]');
            h.unshift({ win, date: new Date().toLocaleString('zh-TW') });
            localStorage.setItem('darkchess_v5', JSON.stringify(h.slice(0, 50)));
        }

        function toggleStats() {
            const m = document.getElementById('modal'), h = JSON.parse(localStorage.getItem('darkchess_v5') || '[]');
            const wins = h.filter(x => x.win).length;
            document.getElementById('summary').innerText = `ÂãùÁéáÔºö${h.length ? (wins/h.length*100).toFixed(1) : 0}% (${wins}/${h.length})`;
            document.getElementById('history').innerHTML = h.map(x => `
                <div style="border-bottom:1px solid #ddd; padding:8px 0; display:flex; justify-content:space-between">
                    <span>${x.date}</span>
                    <span style="color:${x.win?'var(--crimson)':'#000'}">${x.win?'Êç∑':'Êêç'}</span>
                </div>`).join('');
            m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
        }

        function confirmReset() { if(confirm("Á¢∫ÂÆöË¶ÅÊ±ÇÂíåÊàñÈáçÊñ∞‰ΩàÂ±ÄÂóéÔºü")) start(); }
        start();
    </script>
</body>
</html>
